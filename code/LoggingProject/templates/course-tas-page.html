{% extends "base.html" %}
{% load static %}

{% block title %}Course TAs{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto my-12 bg-white p-5 rounded-lg shadow flex flex-col justify-center items-center text-center">
    {% if messages %}
    <ul style="list-style: none; color: red; padding: 0;">
        {% for message in messages %}
            <li style="color: {% if message.tags == 'success' %}green{% else %}red{% endif %};">
                {{ message }}
            </li>
        {% endfor %}
    </ul>
    {% endif %}
    
    <!-- Table Showing TAs Assigned to This Course -->
    <h1 class="text-2xl font-bold text-gray-800">TAs Assigned to {{ course.name }} {{ course.courseid }}-{{course.sectionid}}</h1>
    <table id="assigned-ta-table" class="w-full border-collapse mt-4">
        <thead>
            <tr class="bg-gray-100">
                <th class="py-2 px-2 border border-gray-300 text-center">#</th>
                <th class="py-2 px-4 border border-gray-300">Name</th>
                <th class="py-2 px-2 border border-gray-300">Email</th>
                <th class="py-2 px-2 border border-gray-300">Remove</th>
            </tr>
        </thead>
        <tbody>
            {% for ta in tas %}
            <tr class="hover:bg-gray-50">
                <td class="py-2 px-2 border border-gray-300 text-center">{{ forloop.counter }}</td>
                <td class="py-2 px-4 border border-gray-300">{{ ta.ta.first_name }}{{" "}}{{ ta.ta.last_name }}</td>
                <td class="py-2 px-4 border border-gray-300">{{ ta.ta.email }}</td>
                
                <!-- Remove Button -->
                <td class="py-2 px-2 border border-gray-300 text-center">
                    <form method="post" action="{% url 'removeTA' course_id=course.id ta_user_id=ta.ta.userId %}" onsubmit="return confirm('Are you sure you want to remove this TA from this course?');">
                        {% csrf_token %}
                        <button type="submit" class="btn red-btn" style="width: 60px;">❌</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="py-4 px-4 text-gray-500 italic text-center border border-gray-300">
                    No TAs found.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    <!-- Table Showing All User With The TA Role -->
    <div x-data="{ search: '' }" class="w-full mt-10">
        <h1 class="text-2xl font-bold text-gray-800">Available TAs</h1>
    
        <!-- Search input -->
        <div class="relative w-full max-w-[300px] my-4">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M21 21l-4.35-4.35M16.65 16.65A7.5 7.5 0 1110 2.5a7.5 7.5 0 016.65 14.15z"/>
                </svg>
            </div>
            <input 
                type="text" 
                x-model="search" 
                placeholder="Search by Name/Email..." 
                class="border border-gray-300 rounded px-3 py-2 pl-10 pr-4 w-full"
            />
        </div>
    
        <!-- All TAs Table -->
        <table id="all-ta-table" class="w-full border-collapse mt-4">
            <thead>
                <tr class="bg-gray-100">
                    <th class="py-2 px-2 border border-gray-300 text-center">#</th>
                    <th class="py-2 px-4 border border-gray-300">Name</th>
                    <th class="py-2 px-2 border border-gray-300">Email</th>
                    <th class="py-2 px-2 border border-gray-300">Add</th>
                </tr>
            </thead>
            <tbody>
                {% for ta in all_tas %}
                <tr 
                    x-show="search === '' || '{{ ta.first_name }} {{ ta.last_name }} {{ ta.email }}'.toLowerCase().includes(search.toLowerCase())"
                    class="hover:bg-gray-50"
                >
                    <td class="py-2 px-2 border border-gray-300 text-center">{{ forloop.counter }}</td>
                    <td class="py-2 px-4 border border-gray-300">{{ ta.first_name }} {{ ta.last_name }}</td>
                    <td class="py-2 px-4 border border-gray-300">{{ ta.email }}</td>
                    <td class="py-2 px-2 border border-gray-300 text-center">
                        <form method="post" action="{% url 'assignTA' %}" onsubmit="return confirm('Are you sure you want to add this TA to this course?');">
                            {% csrf_token %}
                            <input type="hidden" name="course_id" value="{{ course.id }}">
                            <input type="hidden" name="ta_email" value="{{ ta.email }}">
                            <button type="submit" class="btn green-btn" style="width: 60px;">✔️</button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="py-4 px-4 text-gray-500 italic text-center border border-gray-300">
                        No TAs found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="addTAModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2>Add Teaching Assistant</h2>
            <form method="post" action="{% url 'assignTA' %}">
                {% csrf_token %}
                <input type="hidden" name="course_id" id="ta_course_id">
                
                <label for="ta_email">TA Email:</label><br>
                <input type="email" name="ta_email" id="ta_email" required style="width: 100%; padding: 8px; margin: 10px 0;"><br>
                
                <button type="submit" class="btn green-btn">Add TA</button>
                <button type="button" class="btn red-btn" onclick="closeAddTAModal()" style="margin-left: 10px;">Cancel</button>
            </form>
        </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://unpkg.com/alpinejs" defer></script>
    <script src="{% static 'js/table-sort.js' %}"></script>

   
    <script>
        function openAddTAModal(courseId) {
            console.log("Opening modal for course:", courseId);
            document.getElementById('ta_course_id').value = courseId;
            document.getElementById('addTAModal').style.display = 'block';
        }

        function closeAddTAModal() {
            document.getElementById('addTAModal').style.display = 'none';
        }

        // Optional: Close modal if user clicks outside the modal content
        window.onclick = function(event) {
            const modal = document.getElementById('addTAModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
{% endblock %}
