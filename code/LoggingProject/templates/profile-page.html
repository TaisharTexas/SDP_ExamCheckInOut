{% extends "base.html" %}
{% load static %}

{% block title %}Profile Page{% endblock title %}

{% block content %}
<div class="max-w-2xl mx-auto mt-10 p-6 bg-white rounded shadow">
  <h2 class="text-2xl font-semibold mb-6 text-center">Your Profile</h2>

  {% if messages %}
    <ul class="list-none p-0 mb-6">
      {% for message in messages %}
        <li class="{% if message.tags == 'success' %}text-green-600{% else %}text-red-600{% endif %}">
          {{ message }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- Profile Info Update -->
  <form method="post" class="space-y-4 mb-8">
    {% csrf_token %}
    {{ profile_form.as_p }}
    <button
      type="submit"
      name="update_profile"
      class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded">
      Update Profile
    </button>
  </form>

  <hr class="my-8">

  <!-- Password Update Section -->
  <h3 class="text-xl font-semibold text-gray-800 mb-4">Change Password</h3>
  <p class="text-sm text-gray-600 mb-4">
    Enter your current password and choose a new one. New passwords must match and meet the strength requirements.
  </p>

  <!-- Trigger Button for Modal -->
  <button
    id="openPasswordModal"
    class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md">
    Change Password
  </button>
</div>

<!-- ===== modernized modal start ===== -->
<div
  id="passwordModal"
  class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex justify-center items-center p-4 hidden">
  <div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-2xl relative">

    <!-- Close “X” -->
    <button
      id="closePasswordModal"
      type="button"
      class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
           viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>

    <h2 class="text-2xl font-semibold text-center mb-6">Change Your Password</h2>
    <p id="error-message" class="text-red-500 text-center mb-4 hidden"></p>

    <form id="password-form" method="post" class="space-y-6">
      {% csrf_token %}
      <input type="hidden" name="change_password" value="1">

      <!-- Current Password -->
      <div class="relative">
        <label for="current_password" class="block text-sm font-medium text-gray-700 mb-1">
          Current Password
        </label>
        <input
          autocomplete="new-password"
          type="password"
          id="current_password"
          name="old_password"
          class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-full
                 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
          required>
        <button
          type="button"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center justify-center
                 w-8 h-8 bg-gray-100 rounded-full shadow-sm hover:bg-indigo-50 transition"
          onclick="togglePwd('current_password', this)">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 eye-icon text-gray-500"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 eye-off-icon hidden text-gray-500"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8"/>
            <path d="M1 1l22 22"/>
            <path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"/>
            <path d="M14.12 14.12A3 3 0 0 1 9.88 9.88"/>
          </svg>
        </button>
      </div>

      <!-- New Password -->
      <div class="relative">
        <label for="new_password" class="block text-sm font-medium text-gray-700 mb-1">
          New Password
        </label>
        <input
          type="password"
          id="new_password"
          name="new_password1"
          class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-full
                 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
          required>
        <button
          type="button"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center justify-center
                 w-8 h-8 bg-gray-100 rounded-full shadow-sm hover:bg-indigo-50 transition"
          onclick="togglePwd('new_password', this)">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 eye-icon text-gray-500"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 eye-off-icon hidden text-gray-500"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8"/>
            <path d="M1 1l22 22"/>
            <path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"/>
            <path d="M14.12 14.12A3 3 0 0 1 9.88 9.88"/>
          </svg>
        </button>
      </div>

      <!-- Confirm New Password -->
      <div class="relative">
        <label for="confirm_password" class="block text-sm font-medium text-gray-700 mb-1">
          Confirm New Password
        </label>
        <input
          type="password"
          id="confirm_password"
          name="new_password2"
          class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-full
                 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
          required>
        <button
          type="button"
          class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center justify-center
                 w-8 h-8 bg-gray-100 rounded-full shadow-sm hover:bg-indigo-50 transition"
          onclick="togglePwd('confirm_password', this)">
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 eye-icon text-gray-500"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg"
               class="h-5 w-5 eye-off-icon hidden text-gray-500"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8"/>
            <path d="M1 1l22 22"/>
            <path d="M9.88 9.88a3 3 0 0 0 4.24 4.24"/>
            <path d="M14.12 14.12A3 3 0 0 1 9.88 9.88"/>
          </svg>
        </button>
      </div>

      <!-- Requirements List -->
      <ul id="pwd-requirements" class="mt-4 space-y-2">
        <li data-check="length" class="flex items-center p-3 border-l-4 border-red-600 bg-gray-50 rounded-md">
          <svg class="h-5 w-5 mr-3 check-icon opacity-0 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 00-1.414 0L7 13.586 4.707 11.293
                     a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l8-8
                     a1 1 0 000-1.414z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-700">At least 8 characters</span>
        </li>
        <li data-check="number" class="flex items-center p-3 border-l-4 border-red-600 bg-gray-50 rounded-md">
          <svg class="h-5 w-5 mr-3 check-icon opacity-0 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 00-1.414 0L7 13.586 4.707 11.293
                     a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l8-8
                     a1 1 0 000-1.414z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-700">Contains a number</span>
        </li>
        <li data-check="symbol" class="flex items-center p-3 border-l-4 border-red-600 bg-gray-50 rounded-md">
          <svg class="h-5 w-5 mr-3 check-icon opacity-0 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 00-1.414 0L7 13.586 4.707 11.293
                     a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l8-8
                     a1 1 0 000-1.414z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-700">Contains a symbol</span>
        </li>
        <li data-check="match" class="flex items-center p-3 border-l-4 border-red-600 bg-gray-50 rounded-md">
          <svg class="h-5 w-5 mr-3 check-icon opacity-0 transition-opacity" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd"
                  d="M16.707 5.293a1 1 0 00-1.414 0L7 13.586 4.707 11.293
                     a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l8-8
                     a1 1 0 000-1.414z" clip-rule="evenodd"/>
          </svg>
          <span class="text-gray-700">Passwords match</span>
        </li>
      </ul>

      <!-- Buttons -->
      <div class="space-y-4 pt-4">
        <button
          type="submit"
          class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md">
          Change Password
        </button>
        <button
          type="button"
          class="w-full py-3 border border-gray-300 hover:border-gray-400 text-gray-700 rounded-full transition"
          onclick="passwordModal.classList.add('hidden')">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
  // Toggle eye icons
  function togglePwd(fieldId, btn) {
    const inp  = document.getElementById(fieldId);
    const show = inp.type === 'password';
    inp.type   = show ? 'text' : 'password';
    btn.querySelector('.eye-icon')   .classList.toggle('hidden', !show);
    btn.querySelector('.eye-off-icon').classList.toggle('hidden',  show);
  }

  // Live validation for new/confirm password
  const newPwd  = document.getElementById('new_password');
  const confirm = document.getElementById('confirm_password');
  function validate() {
    const v = newPwd.value;
    const rules = {
      length: v.length >= 8,
      number: /\d/.test(v),
      symbol: /[!@#\$%\^&\*]/.test(v),
      match:  v === confirm.value && v.length > 0
    };
    Object.entries(rules).forEach(([k, ok]) => {
      const li   = document.querySelector(`[data-check="${k}"]`);
      const icon = li.querySelector('.check-icon');
      li.classList.toggle('border-green-600', ok);
      li.classList.toggle('border-red-600',   !ok);
      icon.classList.toggle('opacity-100',     ok);
      icon.classList.toggle('opacity-0',       !ok);
    });
  }
  newPwd.addEventListener('input', validate);
  confirm.addEventListener('input', validate);

  // Show / hide modal
  document.getElementById('openPasswordModal')
    .addEventListener('click', () => document.getElementById('passwordModal').classList.remove('hidden'));
  document.getElementById('closePasswordModal')
    .addEventListener('click', () => document.getElementById('passwordModal').classList.add('hidden'));

  // AJAX-ify the password change form
  document.getElementById('password-form')
    .addEventListener('submit', async function(e) {
      e.preventDefault();
      const errBox = document.getElementById('error-message');
      errBox.classList.add('hidden');

      const formData = new FormData(this);
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      const response = await fetch(window.location.href, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });

      const payload = await response.json();

      if (response.ok) {
        errBox.textContent = 'Password updated successfully!';
        errBox.classList.remove('hidden','text-red-500');
        errBox.classList.add('text-green-600');
        setTimeout(() => {
          document.getElementById('passwordModal').classList.add('hidden');
          location.reload();
        }, 1500);
      } else {
        const message = payload.error || 'An unexpected error occurred.';
        errBox.textContent = message;
        errBox.classList.remove('hidden','text-green-600');
        errBox.classList.add('text-red-500');
      }
    });
</script>
{% endblock scripts %}
