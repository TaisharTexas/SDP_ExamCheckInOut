{% extends "base.html" %}
{% load static %}

{% block title %}Courses{% endblock %}
{% block style %}{% endblock %}

{% block content %}

{% if user.is_authenticated %}
  <div class="flex items-center justify-between w-full">
    <p class="text-xl font-semibold text-gray-700">Welcome, {{ user.get_full_name }}!</p>
    <a href="{% url 'profilePage' %}" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md font-semibold">Edit Profile</a>
  </div>
{% endif %}

<div class="max-w-7xl mx-auto mb-6 bg-white p-5 rounded-lg shadow flex flex-col justify-center items-center text-center">
    <h1 class ="text-2xl font-bold text-gray-800">Available Courses</h1>
    <!-- displays Error messages for create course form -->
    {% if messages %}
    <ul style="list-style: none; color: red; padding: 0;">
        {% for message in messages %}
            <li style="color: {% if message.tags == 'success' %}green{% else %}red{% endif %};">
                {{ message }}
            </li>
        {% endfor %}
    </ul>
    {% endif %}

        <!-- Course List -->
        <div class="w-full overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-md overflow-hidden">
              <thead class="bg-gray-100 text-gray-800 text-sm font-semibold">
                <tr>
                  <th class="px-6 py-3 text-left">Course Name</th>
                  <th class="px-6 py-3 text-left">Section</th>
                  <th class="px-6 py-3 text-left">Term</th>
                  {% if request.user.role != "TA" %}
                    <th class="px-6 py-3 text-center">Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% for course in courses %}
                  {% if course.courseid %}
                    <tr class="hover:bg-gray-50">
                      <td class="px-6 py-4 text-left">
                        <a href="{% url 'examPage' course.id %}" class="text-emerald-700 hover:underline font-medium">
                          {{course.courseid}} {{ course.name }}
                        </a>
                      </td>
                      <td class="px-6 py-4 text-left">
                        {{ course.sectionid }}
                      </td>
                      <td class="px-6 py-4 text-left">
                        {{ course.semester }} {{ course.year }}
                      </td>
          
                      {% if request.user.role != "TA" %}
                      <td class="px-6 py-4 text-center flex flex-wrap justify-center gap-2">
                        <!-- Edit -->
                        <button
                          type="button"
                          class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded"
                          onclick="openEditModal('{{ course.id }}', '{{ course.name|escapejs }}', '{{ course.courseid }}', '{{ course.sectionid }}', '{{ course.semester }}', '{{ course.year }}')"
                          title="Edit Course">
                          <img src="{% static 'images/editicon.png' %}" alt="Edit Icon" class="h-5 w-5">

                        </button>
          
                        <!-- Delete -->
                        <form method="post" action="{% url 'deleteCourse' course.id %}" onsubmit="return confirm('Are you sure you want to delete this course?');">
                          {% csrf_token %}
                          <button type="submit" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded" title="Delete Course">
                        <img src="{% static 'images/deleteicon.png' %}" alt="Delete Icon" class="h-5 w-5">
                          </button>
                        </form>
          
                        <!-- Add TA -->
                        <button
                          type="button"
                          class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded"
                          onclick="window.location.href='{% url 'course-tas' course.id %}';"
                          title="Add TA">
                          Edit TA
                        </button>
                      </td>
                      {% endif %}
                    </tr>
                  {% else %}
                    <tr><td colspan="4" class="text-red-600">Error: Course ID missing for "{{ course.name }}"</td></tr>
                  {% endif %}
                {% empty %}
                  <tr><td colspan="4" class="text-center text-gray-500 py-4">No courses available.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% if request.user.role != "TA" %} 
        <!-- Add Course Trigger Button -->
        <button class="btn cream-btn" onclick="document.getElementById('addCourseModal').style.display='block'">Add New Course</button>
        {% endif %}
        <!-- Create Course Modal -->
        <div id="addCourseModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10; padding-top: 100px;">
            <div style="background: white; max-width: 400px; margin: auto; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px black; position: relative;">
                <h2>Add a New Course</h2>
                <form method="post" action="{% url 'addCourse' %}">
                    {% csrf_token %}
                    
                    <!--Course Name-->
                    <input class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="text" name="course_name" placeholder="Course Name" required>
                    <!--Course ID-->
                    <input class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="text" name="course_id" placeholder="Course ID" required>
                    <!--Section ID-->
                    <input class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="text" name="section_id" placeholder="Section ID" required>
                    
                    <!--Semester-->
                    <select
                        name="semester" required
                        class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded">
                        <option value="" disabled selected>Semester</option>
                        <option value="Fall">Fall</option>
                        <option value="Spring">Spring</option>
                        <option value="Summer">Summer</option>
                    </select>

                    <!--Year-->
                    <input id="year-field" class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="number" name="year" placeholder="Year" required>
                    <button class="btn green-btn" type="submit">Submit</button>
                </form>
                <button onclick="document.getElementById('addCourseModal').style.display='none'" class="btn red-btn" style="margin-top: 10px;">Cancel</button>
            </div>
        </div>
        <!-- Edit Course Modal -->
        <div id="editCourseModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 10; padding-top: 100px;">
            <div style="background: white; max-width: 400px; margin: auto; padding: 20px; border-radius: 10px; box-shadow: 0px 0px 10px black; position: relative;">
                <h2>Edit Course</h2>
                <form method="post" action="{% url 'editCourse' %}">
                    {% csrf_token %}
                    <input id="edit_course_name" class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="text" name="course_name" required>

                    <!-- Hidden original ID (used to lookup existing course) -->
                    <input type="hidden" name="course_id" id="original_course_id">

                    <!-- Editable new ID -->
                    <input id="edit_course_id" class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="text" name="course_code" required>

                    <input id="edit_section_id" class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="text" name="section_id" required>
                    
                    <!--Editable semester-->
                    <select
                        name="semester" required
                        class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded">
                        <option value="" disabled selected>Semester</option>
                        <option value="Fall">Fall</option>
                        <option value="Spring">Spring</option>
                        <option value="Summer">Summer</option>
                    </select>

                    <!--Editable Year-->
                    <input class="w-[90%] px-3 py-2 my-2 border border-gray-300 rounded" type="number" name="year" placeholder="Year" required>


                    <button class="btn gold-btn" type="submit">Update</button>
                </form>
                <button onclick="document.getElementById('editCourseModal').style.display='none'" class="btn red-btn" style="margin-top: 10px;">Cancel</button>
            </div>
        </div>
</div>
{% endblock %}

<!-- MOVED JS FILE HERE, BECAUSE IT WASNT BEING READ CORRECTLY (IDK WHY) -->
{% block scripts %}
    
<script>
    function openEditModal(id, name, courseid, sectionid, semester, year) {
        //console.log("Edit Modal Data:", { id, name, courseid, sectionid, semester, year });
    
        document.getElementById('edit_course_name').value = name;
        document.getElementById('edit_course_id').value = courseid;
        document.getElementById('edit_section_id').value = sectionid;
        document.getElementById('original_course_id').value = id;
    
        const semesterSelect = document.querySelector('#editCourseModal select[name="semester"]');
        const yearInput = document.querySelector('#editCourseModal input[name="year"]');
    
        semesterSelect.value = semester;
        yearInput.value = year;
    
        document.getElementById("editCourseModal").style.display = "block";
    }

    document.addEventListener("DOMContentLoaded", function () {
        const yearField = document.getElementById("year-field");
        const currentYear = new Date().getFullYear();
        if (yearField) {
            yearField.value = currentYear;
        }
    });
</script>

{% endblock %}